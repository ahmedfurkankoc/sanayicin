## Nginx configuration for test environment (noindex) serving 3 apps:
## - frontend (Next.js) at /
## - admin (Next.js) at /admin (and optional admin subdomain server below)
## - backend API (Django) at /api (bind backend to 127.0.0.1 to prevent direct access)

## Rate limit for API to mitigate abuse (tune values per needs)
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/m;

server {
    listen 80;
    listen 443 ssl;
    server_name test.sanayicin.com;

    # SSL (optional in test)
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;

    # No-index headers for test environment
    add_header X-Robots-Tag "noindex, nofollow" always;
    add_header X-Robots-Tag "noarchive, nosnippet, noimageindex" always;

    # Security headers (basic, extend as needed)
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header Referrer-Policy no-referrer-when-downgrade always;

    # Frontend (Next.js dev or SSR)
    # Adjust port if different (e.g., production: serve built assets instead of proxy)
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Admin (Next.js) under /admin path
    # Adjust port to your admin dev server (e.g., 3001)
    location /admin/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # Backend API (Django/DRF). Bind gunicorn/uvicorn only to 127.0.0.1:8000.
    # Optionally uncomment allow/deny to restrict by IP.
    location /api/ {
        # allow 127.0.0.1;      # allow only local (requests via this proxy)
        # deny all;             # uncomment together with 'allow' to hard block outside
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket (ASGI) if used, e.g., /ws/
    location /ws/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Media files (avatars, uploads)
    location /media/ {
        alias /var/www/sanayicin/media/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header X-Robots-Tag "noindex, nofollow" always;
    }

    # Static (optional, if backend serves collected static)
    # location /static/ {
    #     alias /var/www/sanayicin/static/;
    #     expires 30d;
    #     add_header Cache-Control "public, immutable";
    # }

    # robots.txt
    location = /robots.txt {
        alias /var/www/sanayicin/frontend/public/robots.txt;
        add_header Content-Type text/plain;
    }
}

# Optional: dedicated admin subdomain in test (maps to same admin Next.js)
server {
    listen 80;
    listen 443 ssl;
    server_name admin.test.sanayicin.com;

    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;

    # No-index for test
    add_header X-Robots-Tag "noindex, nofollow" always;
    add_header X-Robots-Tag "noarchive, nosnippet, noimageindex" always;

    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}